---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Okul Yurt Rehberi | Modern Arama">
	<main class="max-w-6xl mx-auto px-6 py-12 md:py-20">
		<!-- Hero Section -->
		<header class="text-center mb-16 space-y-4">
			<div class="inline-flex items-center gap-2 px-4 py-2 bg-primary-50 text-primary-600 rounded-full text-sm font-semibold mb-2">
				<span class="relative flex h-3 w-3">
					<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary-400 opacity-75"></span>
					<span class="relative inline-flex rounded-full h-3 w-3 bg-primary-500"></span>
				</span>
				GÃ¼ncel Yurt Verileri
			</div>
			<h1 class="text-5xl md:text-6xl font-extrabold text-slate-900 tracking-tight">
				ğŸ  <span class="bg-clip-text text-transparent bg-gradient-to-r from-primary-600 to-indigo-600">Yurt Rehberi</span>
			</h1>
			<p class="text-lg text-slate-600 max-w-2xl mx-auto leading-relaxed">
				Okulunuzu seÃ§in, size en uygun ve en yakÄ±n yurtlarÄ± anÄ±nda listeleyelim.
			</p>
		</header>

		<!-- Selection Section -->
		<section class="mb-16">
			<div class="max-w-2xl mx-auto">
				<div class="relative group">
					<div class="absolute -inset-1 bg-gradient-to-r from-primary-600 to-indigo-600 rounded-3xl blur opacity-20 group-hover:opacity-30 transition duration-1000 group-hover:duration-200"></div>
					<div class="relative bg-white rounded-2xl shadow-xl p-8">
						<label for="okulSecimi" class="block text-sm font-bold text-slate-700 mb-4 uppercase tracking-wider">
							Hedef Okulunuzu Belirleyin
						</label>
						<div class="relative">
							<select
								id="okulSecimi"
								class="block w-full px-6 py-4 text-lg bg-slate-50 border-2 border-slate-100 rounded-xl focus:ring-4 focus:ring-primary-100 focus:border-primary-500 transition-all appearance-none cursor-pointer outline-none text-slate-700 font-medium"
							>
								<option value="">Veriler yÃ¼kleniyor...</option>
							</select>
							<div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none text-slate-400">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
								</svg>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

		<!-- Info Section -->
		<div id="okulDetayAlani" class="space-y-12 mb-12 animate-in fade-in duration-700"></div>

		<!-- List Section -->
		<div id="yurtListesi" class="grid gap-8 animate-in slide-in-from-bottom duration-700"></div>

		<!-- Footer/Empty State -->
		<div id="emptyState" class="hidden text-center py-20 bg-white rounded-3xl border-2 border-dashed border-slate-200">
			<div class="text-6xl mb-6">ğŸ”</div>
			<h4 class="text-2xl font-bold text-slate-800 mb-2">ÃœzgÃ¼nÃ¼z, SonuÃ§ BulunamadÄ±</h4>
			<p class="text-slate-500">SeÃ§tiÄŸiniz okul iÃ§in ÅŸu an kayÄ±tlÄ± bir yurt verisi bulunmuyor.</p>
		</div>
	</main>

	<!-- UI Scripts -->
	<script>
		let GLOBAL_DATA = null;
		const API_URL = "https://script.google.com/macros/s/AKfycbzTVfLlTDS8IQv9JvLaMoEFZYZnRwBveDmevBF6i0fYyVq6Hsa7Zp0mQDkXDRUJhs0/exec";
		const LS_KEY = "OKUL_YURT_DATA_V1";
		const TTL = 5 * 60 * 1000;

		const select = document.getElementById('okulSecimi') as HTMLSelectElement;
		const listDiv = document.getElementById('yurtListesi');
		const detailDiv = document.getElementById('okulDetayAlani');
		const emptyState = document.getElementById('emptyState');

		function loadCache() {
			const raw = localStorage.getItem(LS_KEY);
			if (!raw) return null;
			try {
				const parsed = JSON.parse(raw);
				if (Date.now() - parsed.ts > TTL) return null;
				return parsed.data;
			} catch { return null; }
		}

		function saveCache(data: any) {
			localStorage.setItem(LS_KEY, JSON.stringify({ ts: Date.now(), data }));
		}

		async function fetchData() {
			const cachedData = loadCache();
			if (cachedData) {
				GLOBAL_DATA = cachedData;
				renderDropdown(cachedData);
			}

			try {
				const res = await fetch(API_URL, { redirect: "follow" });
				const data = await res.json();
				
				if (JSON.stringify(cachedData) !== JSON.stringify(data)) {
					GLOBAL_DATA = data;
					saveCache(data);
					renderDropdown(data);
				}
			} catch (err) {
				console.error("Fetch Error:", err);
			}
		}

		function renderDropdown(data: any) {
			if (!select) return;
			select.innerHTML = '<option value="">LÃ¼tfen okulu seÃ§iniz...</option>';
			data.okulListesi.forEach((okul: any) => {
				if (okul[0] && okul[1]) {
					const opt = document.createElement("option");
					opt.value = okul[0].toString().trim();
					opt.text = okul[1].toString().trim();
					select.appendChild(opt);
				}
			});
		}

		function handleSelection() {
			const id = select.value;
			if (!id || !GLOBAL_DATA) {
				if (listDiv) listDiv.innerHTML = "";
				if (detailDiv) detailDiv.innerHTML = "";
				emptyState?.classList.add('hidden');
				return;
			}

			const okul = GLOBAL_DATA.okulListesi.find((o: any) => o[0].toString().trim() === id);
			if (okul && detailDiv) {
				detailDiv.innerHTML = `
					<div class="bg-white rounded-3xl p-8 shadow-sm border border-primary-100 border-l-[8px] border-primary-500">
						<div class="flex flex-col md:flex-row gap-8 items-center">
							<div class="flex-1 space-y-4">
								<h2 class="text-3xl font-bold text-slate-800">ğŸ« ${okul[1]}</h2>
								<p class="text-slate-600 flex items-center gap-2">
									<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
									</svg>
									${okul[3]}
								</p>
							</div>
							<div class="w-full md:w-1/3 h-48 rounded-2xl overflow-hidden shadow-inner bg-slate-100">
								<iframe src="${okul[2]}" class="w-full h-full border-0" loading="lazy"></iframe>
							</div>
						</div>
					</div>
					<div class="text-center">
						<h3 class="text-2xl font-bold text-slate-800 inline-block relative">
							ğŸ‘‡ YakÄ±ndaki Yurtlar
							<div class="absolute -bottom-2 left-0 right-0 h-1 bg-primary-100 rounded-full"></div>
						</h3>
					</div>
				`;
			}

			const matches = GLOBAL_DATA.yurtListesi.filter((y: any) => {
				const idList = (y[0] || "").toString().split(',').map((i: string) => i.trim());
				return idList.includes(id);
			});

			renderYurtlar(matches);
		}

		function renderYurtlar(yurtlar: any[]) {
			if (!listDiv) return;
			listDiv.innerHTML = "";
			
			if (yurtlar.length === 0) {
				emptyState?.classList.remove('hidden');
				return;
			}

			emptyState?.classList.add('hidden');
			yurtlar.forEach(yurt => {
				const card = `
					<div class="group bg-white rounded-3xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 border border-slate-100 mb-6">
						<div class="flex flex-col md:flex-row">
							<div class="relative w-full md:w-2/5 min-h-[300px] overflow-hidden">
								<iframe src="${yurt[2]}" class="absolute inset-0 w-full h-full border-0" loading="lazy"></iframe>
							</div>
							<div class="p-8 md:p-10 flex-1 flex flex-col justify-center">
								<h3 class="text-2xl font-bold text-slate-800 mb-3">${yurt[1]}</h3>
								<div class="space-y-3 mb-6">
									<p class="text-sm text-slate-600 flex items-start gap-2"><strong>ğŸ“:</strong> ${yurt[3]}</p>
									<p class="text-sm text-slate-600 flex items-start gap-2"><strong>ğŸ‘¤:</strong> ${yurt[4]}</p>
								</div>
								<div class="flex flex-wrap gap-3">
									<a href="tel:${yurt[5].toString().replace(/\s/g, '')}" class="px-6 py-3 bg-primary-600 text-white rounded-2xl font-semibold shadow-lg shadow-primary-500/20 hover:bg-primary-700 transition-all">
										ğŸ“ ${yurt[5]}
									</a>
									<button data-ad="${yurt[1]}" class="like-btn px-6 py-3 border-2 border-slate-100 rounded-2xl font-semibold text-slate-600 hover:bg-red-50 hover:text-red-600 hover:border-red-100 transition-all">
										ğŸ¤ BeÄŸen
									</button>
								</div>
							</div>
						</div>
					</div>
				`;
				listDiv.innerHTML += card;
			});

			// Re-bind like buttons
			document.querySelectorAll('.like-btn').forEach(btn => {
				btn.addEventListener('click', (e) => {
					const ad = (e.currentTarget as HTMLElement).dataset.ad;
					if (ad) tikSayisiniArtir(ad);
					(e.currentTarget as HTMLElement).innerHTML = 'â¤ï¸ BeÄŸenildi';
					(e.currentTarget as HTMLElement).classList.add('text-red-600', 'bg-red-50');
				});
			});
		}

		async function tikSayisiniArtir(yurtAdi: string) {
			try {
				await fetch(API_URL, {
					method: "POST",
					mode: "no-cors",
					cache: "no-cache",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ action: "artirTik", yurtAdi })
				});
			} catch (err) { console.error("Like Error:", err); }
		}

		select?.addEventListener('change', handleSelection);
		window.addEventListener('DOMContentLoaded', fetchData);
	</script>
</Layout>
